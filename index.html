<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>WebCam Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}

:root{
  --bg:#0a0a0a;--surface:#141414;--surface-2:#1e1e1e;
  --accent:#ff3b30;--accent-2:#ff6b5a;
  --text:#f0f0f0;--text-dim:#888;--border:#2a2a2a;
  --glass:rgba(20,20,20,0.85);--glass-border:rgba(255,255,255,0.06);
}

html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'JetBrains Mono',monospace;color:var(--text);touch-action:none}

#app{width:100%;height:100%;display:flex;flex-direction:column;position:relative}

.ico{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

#videoContainer{position:absolute;top:0;left:0;width:100%;height:100%;overflow:hidden;background:#000}
#video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
#video.back-camera{transform:scaleX(1)}
#canvas{display:none}

#flashOverlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none;z-index:50;transition:opacity .1s}
#flashOverlay.flash{opacity:1;transition:opacity .05s}

#topBar{position:absolute;top:0;left:0;right:0;z-index:10;padding:env(safe-area-inset-top,12px) 16px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,.7) 0%,transparent 100%)}
.top-left,.top-right{display:flex;gap:14px;align-items:center}

.top-btn{width:40px;height:40px;border-radius:50%;background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-border);color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.top-btn:active{transform:scale(.9);background:rgba(255,255,255,.15)}
.top-btn.active{color:#ffd60a}

#timerDisplay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:96px;font-weight:600;color:#fff;text-shadow:0 0 40px rgba(255,59,48,.5);z-index:40;display:none;animation:tp 1s ease-in-out infinite}
@keyframes tp{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:1}50%{transform:translate(-50%,-50%) scale(1.1);opacity:.8}}

#recordIndicator{position:absolute;top:80px;left:50%;transform:translateX(-50%);z-index:15;display:none;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;background:rgba(255,59,48,.2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,59,48,.3);font-size:13px;font-weight:500;letter-spacing:1px}
#recordDot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:bl 1s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}

#zoomIndicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:15;padding:8px 20px;border-radius:24px;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);font-size:18px;font-weight:500;display:none;pointer-events:none}

#filterName{position:absolute;bottom:200px;left:50%;transform:translateX(-50%);z-index:15;padding:6px 16px;border-radius:16px;background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-border);font-size:12px;color:var(--text-dim);display:none;pointer-events:none}

#filtersPanel{position:absolute;bottom:180px;left:0;right:0;z-index:12;display:none;padding:12px 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
#filtersPanel::-webkit-scrollbar{display:none}
.filters-row{display:flex;gap:10px;padding:0 12px;width:max-content}
.filter-item{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
.filter-preview{width:56px;height:56px;border-radius:12px;background:var(--surface-2);border:2px solid transparent;overflow:hidden;transition:all .2s}
.filter-preview.active{border-color:var(--accent);box-shadow:0 0 12px rgba(255,59,48,.3)}
.filter-label{font-size:10px;color:var(--text-dim);letter-spacing:.5px;text-transform:uppercase}
.filter-item.active .filter-label{color:var(--accent-2)}

#bottomBar{position:absolute;bottom:0;left:0;right:0;z-index:10;padding:16px 24px;padding-bottom:max(env(safe-area-inset-bottom,16px),20px);background:linear-gradient(to top,rgba(0,0,0,.8) 0%,transparent 100%)}

#modeSelector{display:flex;justify-content:center;gap:24px;margin-bottom:20px}
.mode-btn{font-size:12px;font-weight:500;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);background:none;border:none;cursor:pointer;padding:4px 8px;transition:all .3s;position:relative;font-family:inherit}
.mode-btn.active{color:#ffd60a}
.mode-btn.active::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:#ffd60a}

#captureRow{display:flex;justify-content:space-evenly;align-items:center}

#shutterBtn{width:72px;height:72px;border-radius:50%;background:transparent;border:3px solid var(--text);cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;transition:all .2s}
#shutterBtn:active{transform:scale(.92)}
#shutterInner{width:58px;height:58px;border-radius:50%;background:var(--text);transition:all .3s}
#shutterBtn.recording #shutterInner{width:28px;height:28px;border-radius:6px;background:var(--accent)}
#shutterBtn.video-mode #shutterInner{background:var(--accent)}

.side-btn{width:48px;height:48px;border-radius:50%;background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-border);color:var(--text);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.side-btn:active{transform:scale(.9)}

#zoomSlider{position:absolute;right:16px;top:50%;transform:translateY(-50%);z-index:11;display:none;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;border-radius:24px;background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-border)}
#zoomRange{writing-mode:vertical-lr;direction:rtl;-webkit-appearance:none;appearance:none;width:4px;height:150px;background:var(--border);border-radius:2px;outline:none}
#zoomRange::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--text);cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,.5)}
.zoom-label{font-size:10px;color:var(--text-dim)}

.popup-panel{position:absolute;top:60px;z-index:20;display:none;flex-direction:column;gap:2px;border-radius:14px;overflow:hidden;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border)}
#timerOptions{left:16px}
#ratioSelector{right:16px}
.popup-opt{padding:10px 20px;font-size:14px;color:var(--text);cursor:pointer;transition:background .2s;border:none;background:transparent;font-family:inherit;text-align:center}
.popup-opt:active,.popup-opt.active{background:rgba(255,255,255,.1)}

/* Settings */
#settingsPanel{position:absolute;top:0;left:0;right:0;bottom:0;z-index:60;background:var(--bg);display:none;flex-direction:column;overflow-y:auto}
.settings-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;padding-top:max(env(safe-area-inset-top,16px),16px);border-bottom:1px solid var(--border)}
.settings-header h2{font-size:18px;font-weight:500;letter-spacing:.5px}
.settings-close{width:36px;height:36px;border-radius:50%;background:var(--surface-2);border:none;color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer}
.settings-group{padding:20px;border-bottom:1px solid var(--border)}
.settings-group-title{font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:14px}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
.setting-label{font-size:14px}
.res-options{display:flex;gap:8px;flex-wrap:wrap}
.res-btn{padding:6px 14px;border-radius:8px;background:var(--surface-2);border:1px solid var(--border);color:var(--text-dim);font-size:12px;font-family:inherit;cursor:pointer;transition:all .2s}
.res-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}

.toggle-wrap{position:relative;width:44px;height:24px;cursor:pointer}
.toggle-track{position:absolute;top:0;left:0;right:0;bottom:0;background:var(--surface-2);border-radius:12px;transition:.3s}
.toggle-track.on{background:var(--accent)}
.toggle-dot{position:absolute;top:2px;left:2px;width:20px;height:20px;background:var(--text-dim);border-radius:50%;transition:.3s}
.toggle-dot.on{transform:translateX(20px);background:#fff}

#toast{position:fixed;bottom:120px;left:50%;transform:translateX(-50%) translateY(80px);z-index:300;padding:10px 24px;border-radius:24px;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);font-size:13px;color:var(--text);opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.upload-overlay{position:absolute;top:0;left:0;right:0;bottom:0;z-index:210;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);gap:16px}
.upload-progress-ring{width:80px;height:80px;transform:rotate(-90deg)}
.upload-progress-ring circle{fill:none;stroke-width:5;stroke-linecap:round}
.upload-progress-ring .ring-bg{stroke:var(--surface-2)}
.upload-progress-ring .ring-fill{stroke:var(--accent);stroke-dasharray:226;stroke-dashoffset:226;transition:stroke-dashoffset .2s}
.upload-pct{font-size:24px;font-weight:500;color:var(--text);letter-spacing:1px}
.upload-status{font-size:13px;color:var(--text-dim);letter-spacing:.5px}

/* Permission Screen */
#permScreen{position:absolute;top:0;left:0;right:0;bottom:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);gap:24px;padding:32px;text-align:center}
#permScreen h2{font-size:20px;font-weight:500}
#permScreen p{font-size:14px;color:var(--text-dim);line-height:1.6}
#permBtn{padding:12px 32px;border-radius:12px;background:var(--accent);border:none;color:#fff;font-size:15px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s}
#permBtn:active{transform:scale(.96);opacity:.9}

/* Grid */
#gridOverlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;display:none}
#gridOverlay.show{display:block}
.grid-line{position:absolute;background:rgba(255,255,255,.15)}
.gl-h{left:0;right:0;height:1px}.gl-v{top:0;bottom:0;width:1px}
.gl-h1{top:33.33%}.gl-h2{top:66.66%}.gl-v1{left:33.33%}.gl-v2{left:66.66%}

/* ===== SAVE SCREEN ===== */
#saveScreen{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;
  display:none;flex-direction:column;background:#000;
}
#saveScreen.show{display:flex}

.save-top{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;padding-top:max(env(safe-area-inset-top,12px),12px);
  background:rgba(0,0,0,.9);z-index:2;
}
.save-top-btn{
  padding:8px 16px;border-radius:10px;border:none;font-size:14px;
  font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s;
}
.save-top-btn:active{transform:scale(.95)}
.save-back{background:var(--surface-2);color:var(--text)}
.save-share{background:var(--accent);color:#fff}
.save-download{background:#30d158;color:#fff}

.save-body{
  flex:1;display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
}
.save-body img{
  max-width:100%;max-height:100%;object-fit:contain;
  /* CRITICAL: allow user to long-press save */
  -webkit-touch-callout:default !important;
  -webkit-user-select:auto !important;
  user-select:auto !important;
}
.save-body video{
  max-width:100%;max-height:100%;object-fit:contain;
}

.save-bottom{
  padding:16px 20px;padding-bottom:max(env(safe-area-inset-bottom,16px),20px);
  background:rgba(0,0,0,.9);text-align:center;z-index:2;
}
.save-hint{
  font-size:13px;color:var(--text-dim);line-height:1.5;
  margin-bottom:12px;
}
.save-hint b{color:#ffd60a;font-weight:500}
.save-actions{display:flex;gap:10px;justify-content:center}
</style>
</head>
<body>

<div id="app">
  <!-- Permission Screen -->
  <div id="permScreen">
    <svg viewBox="0 0 24 24" style="width:56px;height:56px;fill:none;stroke:var(--accent);stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round"><rect x="2" y="5" width="20" height="14" rx="2"/><circle cx="12" cy="12" r="3.5"/><circle cx="17" cy="7.5" r="1" fill="var(--accent)"/></svg>
    <h2>WebCam Pro</h2>
    <p>Разрешите доступ к камере и микрофону для использования приложения</p>
    <button id="permBtn">Разрешить доступ</button>
  </div>

  <div id="videoContainer">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="flashOverlay"></div>

  <div id="gridOverlay">
    <div class="grid-line gl-h gl-h1"></div>
    <div class="grid-line gl-h gl-h2"></div>
    <div class="grid-line gl-v gl-v1"></div>
    <div class="grid-line gl-v gl-v2"></div>
  </div>

  <div id="timerDisplay"></div>
  <div id="recordIndicator"><div id="recordDot"></div><span id="recordTime">00:00</span></div>
  <div id="zoomIndicator"></div>
  <div id="filterName"></div>

  <!-- Top Bar -->
  <div id="topBar">
    <div class="top-left">
      <button class="top-btn" id="flashBtn">
        <svg class="ico" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      </button>
      <button class="top-btn" id="timerBtn">
        <svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="13" r="8"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="13" x2="15" y2="13"/><line x1="9" y1="1" x2="15" y2="1"/><line x1="12" y1="1" x2="12" y2="4"/></svg>
      </button>
      <button class="top-btn" id="gridBtn">
        <svg class="ico" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>
      </button>
    </div>
    <div class="top-right">
      <button class="top-btn" id="ratioBtn">
        <svg class="ico" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
      </button>
      <button class="top-btn" id="filterBtn">
        <svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20 7 7 0 0 1 0-14 4 4 0 0 1 0 8 1 1 0 0 1 0-2"/></svg>
      </button>
      <button class="top-btn" id="settingsBtn">
        <svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </div>

  <!-- Popups -->
  <div id="timerOptions" class="popup-panel">
    <button class="popup-opt active" data-val="0">Выкл</button>
    <button class="popup-opt" data-val="3">3 сек</button>
    <button class="popup-opt" data-val="5">5 сек</button>
    <button class="popup-opt" data-val="10">10 сек</button>
  </div>
  <div id="ratioSelector" class="popup-panel">
    <button class="popup-opt active" data-val="full">Полный</button>
    <button class="popup-opt" data-val="4:3">4:3</button>
    <button class="popup-opt" data-val="16:9">16:9</button>
    <button class="popup-opt" data-val="1:1">1:1</button>
  </div>

  <div id="filtersPanel"><div class="filters-row" id="filtersRow"></div></div>

  <div id="zoomSlider">
    <span class="zoom-label">+</span>
    <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1">
    <span class="zoom-label">1x</span>
  </div>

  <!-- Bottom Bar -->
  <div id="bottomBar">
    <div id="modeSelector">
      <button class="mode-btn active" data-mode="photo">Фото</button>
      <button class="mode-btn" data-mode="video">Видео</button>
    </div>
    <div id="captureRow">
      <button class="side-btn" id="switchCamBtn">
        <svg class="ico" viewBox="0 0 24 24" style="width:24px;height:24px"><path d="M20 16v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-4"/><path d="M4 8V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><polyline points="16 12 12 8 8 12"/><polyline points="8 12 12 16 16 12"/></svg>
      </button>
      <button id="shutterBtn"><div id="shutterInner"></div></button>
      <button class="side-btn" id="zoomBtn">
        <svg class="ico" viewBox="0 0 24 24" style="width:24px;height:24px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
      </button>
    </div>
  </div>

  <div id="toast"></div>

  <!-- ===== SAVE SCREEN (фото/видео на весь экран) ===== -->
  <div id="saveScreen">
    <div class="save-top">
      <button class="save-top-btn save-back" id="saveBackBtn">Назад</button>
      <div style="display:flex;gap:8px">
        <button class="save-top-btn save-download" id="saveDownBtn">Скачать</button>
        <button class="save-top-btn save-share" id="saveShareBtn">Отправить</button>
      </div>
    </div>
    <div class="save-body" id="saveBody"></div>
    <div class="save-bottom">
      <div class="save-hint" id="saveHint"></div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settingsPanel">
    <div class="settings-header">
      <h2>Настройки</h2>
      <button class="settings-close" id="settingsCloseBtn">
        <svg class="ico" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">Разрешение фото</div>
      <div class="res-options" id="photoResOpts">
        <button class="res-btn" data-val="hd">HD</button>
        <button class="res-btn active" data-val="fhd">Full HD</button>
        <button class="res-btn" data-val="4k">4K</button>
        <button class="res-btn" data-val="max">Max</button>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">Разрешение видео</div>
      <div class="res-options" id="videoResOpts">
        <button class="res-btn" data-val="480">480p</button>
        <button class="res-btn active" data-val="720">720p</button>
        <button class="res-btn" data-val="1080">1080p</button>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">Формат фото</div>
      <div class="res-options" id="formatOpts">
        <button class="res-btn active" data-val="jpeg">JPEG</button>
        <button class="res-btn" data-val="png">PNG</button>
        <button class="res-btn" data-val="webp">WebP</button>
      </div>
    </div>
    <div class="settings-group">
      <div class="settings-group-title">Качество JPEG</div>
      <div class="setting-row">
        <input type="range" min="0.1" max="1" step="0.1" value="1" id="qualityRange" style="flex:1;accent-color:var(--accent)">
        <span style="font-size:13px;color:var(--text-dim);margin-left:12px" id="qualityLabel">100%</span>
      </div>
    </div>
    <div class="settings-group">
      <div class="setting-row">
        <span class="setting-label">Звук затвора</span>
        <div class="toggle-wrap" id="soundToggle">
          <div class="toggle-track on"></div>
          <div class="toggle-dot on"></div>
        </div>
      </div>
    </div>
    <div class="settings-group" style="border:none">
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:13px;color:var(--text-dim)">WebCam Pro v1.0</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let mode='photo',facing='user',filterIdx=0,timerSec=0,recording=false,
      recorder=null,chunks=[],recStart=0,recInterval=null,stream=null,track=null,
      flashMode='off',zoom=1,maxZoom=5,gridOn=false,filtersOn=false,zoomOn=false,
      fmt='jpeg',quality=1.0,soundOn=true,photoRes='fhd',videoRes='720',
      pendingBlob=null,pendingName='',pendingType='',lastRecDurationMs=0;

  const FILTERS=[
    {name:'Нет',css:'none'},{name:'Ч/Б',css:'grayscale(100%)'},{name:'Сепия',css:'sepia(100%)'},
    {name:'Инверсия',css:'invert(100%)'},{name:'Контраст',css:'contrast(150%)'},
    {name:'Яркость',css:'brightness(130%)'},{name:'Насыщ.',css:'saturate(200%)'},
    {name:'Тепло',css:'sepia(40%) saturate(150%)'},{name:'Холод',css:'saturate(80%) hue-rotate(180deg)'},
    {name:'Винтаж',css:'sepia(50%) contrast(90%) brightness(110%)'},
    {name:'Драма',css:'contrast(140%) brightness(90%) saturate(120%)'},
  ];

  const $=id=>document.getElementById(id);
  const video=$('video'),canvas=$('canvas'),ctx=canvas.getContext('2d');

  // === FILTERS UI ===
  const fr=$('filtersRow');
  FILTERS.forEach((f,i)=>{
    const d=document.createElement('div');
    d.className='filter-item'+(i===0?' active':'');
    d.innerHTML=`<div class="filter-preview${i===0?' active':''}"><div style="width:100%;height:100%;background:linear-gradient(135deg,#666,#333);filter:${f.css==='none'?'':f.css}"></div></div><span class="filter-label">${f.name}</span>`;
    d.onclick=()=>setFilter(i);
    fr.appendChild(d);
  });

  function setFilter(i){
    filterIdx=i;
    video.style.filter=FILTERS[i].css==='none'?'':FILTERS[i].css;
    fr.querySelectorAll('.filter-item').forEach((el,j)=>{
      el.className='filter-item'+(j===i?' active':'');
      el.querySelector('.filter-preview').className='filter-preview'+(j===i?' active':'');
    });
    if(i>0){$('filterName').textContent=FILTERS[i].name;$('filterName').style.display='block';setTimeout(()=>$('filterName').style.display='none',1200)}
  }

  // === CAMERA ===
  $('permBtn').onclick=initCam;

  async function initCam(){
    try{
      const c=getCon();
      try{
        stream=await navigator.mediaDevices.getUserMedia(c);
      }catch(e){
        // Если аудио отклонено — пробуем только видео
        delete c.audio;
        stream=await navigator.mediaDevices.getUserMedia(c);
      }
      video.srcObject=stream;
      track=stream.getVideoTracks()[0];
      video.className=facing==='user'?'':'back-camera';
      const caps=track.getCapabilities?track.getCapabilities():{};
      if(caps.zoom){maxZoom=Math.min(caps.zoom.max,10);$('zoomRange').max=maxZoom}
      $('permScreen').style.display='none';
    }catch(e){toast('Ошибка: '+e.message)}
  }

  function getCon(){
    let w,h;
    if(mode==='video'){switch(videoRes){case'480':w=640;h=480;break;case'1080':w=1920;h=1080;break;default:w=1280;h=720}}
    else{switch(photoRes){case'hd':w=1280;h=720;break;case'4k':w=3840;h=2160;break;case'max':w=4096;h=2160;break;default:w=1920;h=1080}}
    return{video:{facingMode:facing,width:{ideal:w},height:{ideal:h}},audio:{
      channelCount:{ideal:2},
      sampleRate:{ideal:48000},
      echoCancellation:{ideal:false},
      noiseSuppression:{ideal:false},
      autoGainControl:{ideal:false}
    }};
  }

  // === CONTROLS ===
  $('switchCamBtn').onclick=async()=>{
    facing=facing==='user'?'environment':'user';
    if(stream)stream.getTracks().forEach(t=>t.stop());
    await initCam();
    if(filterIdx>0)video.style.filter=FILTERS[filterIdx].css;
    toast(facing==='user'?'Фронтальная':'Задняя');
  };

  $('flashBtn').onclick=()=>{
    flashMode=flashMode==='off'?'on':'off';
    $('flashBtn').classList.toggle('active',flashMode==='on');
    if(track){try{track.applyConstraints({advanced:[{torch:flashMode==='on'}]})}catch(e){}}
    toast('Вспышка: '+(flashMode==='on'?'Вкл':'Выкл'));
  };

  $('timerBtn').onclick=()=>togglePopup('timerOptions');
  $('timerOptions').querySelectorAll('.popup-opt').forEach(b=>b.onclick=()=>{
    timerSec=parseInt(b.dataset.val);
    $('timerOptions').querySelectorAll('.popup-opt').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    $('timerOptions').style.display='none';
    $('timerBtn').classList.toggle('active',timerSec>0);
    toast(timerSec>0?'Таймер: '+timerSec+'s':'Таймер выкл');
  });

  $('gridBtn').onclick=()=>{gridOn=!gridOn;$('gridOverlay').className=gridOn?'show':'';$('gridBtn').classList.toggle('active',gridOn)};

  $('ratioBtn').onclick=()=>togglePopup('ratioSelector');
  $('ratioSelector').querySelectorAll('.popup-opt').forEach(b=>b.onclick=()=>{
    const r=b.dataset.val,vc=$('videoContainer');
    $('ratioSelector').querySelectorAll('.popup-opt').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');$('ratioSelector').style.display='none';
    switch(r){
      case'full':vc.style.clipPath='';break;
      case'4:3':{const h=window.innerWidth*(4/3),t=(window.innerHeight-h)/2;vc.style.clipPath=`inset(${Math.max(0,t)}px 0)`;break}
      case'16:9':{const h=window.innerWidth*(16/9),t=(window.innerHeight-h)/2;vc.style.clipPath=`inset(${Math.max(0,t)}px 0)`;break}
      case'1:1':{const s=window.innerWidth,t=(window.innerHeight-s)/2;vc.style.clipPath=`inset(${Math.max(0,t)}px 0)`;break}
    }
    toast('Формат: '+r);
  });

  $('filterBtn').onclick=()=>{filtersOn=!filtersOn;$('filtersPanel').style.display=filtersOn?'block':'none';$('filterBtn').classList.toggle('active',filtersOn)};

  $('zoomBtn').onclick=()=>{zoomOn=!zoomOn;$('zoomSlider').style.display=zoomOn?'flex':'none'};
  $('zoomRange').oninput=function(){applyZoom(parseFloat(this.value))};

  function applyZoom(v){
    zoom=v;
    if(track){try{track.applyConstraints({advanced:[{zoom}]})}catch(e){video.style.transform=`scale(${facing==='user'?-zoom:zoom},${zoom})`}}
    $('zoomIndicator').textContent=zoom.toFixed(1)+'x';$('zoomIndicator').style.display='block';
    clearTimeout(applyZoom._t);applyZoom._t=setTimeout(()=>$('zoomIndicator').style.display='none',1000);
  }

  // === MODE ===
  $('modeSelector').querySelectorAll('.mode-btn').forEach(b=>b.onclick=()=>{
    mode=b.dataset.mode;
    $('modeSelector').querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    $('shutterInner').style.background=mode==='video'?'var(--accent)':'var(--text)';
    $('shutterBtn').className=mode==='video'?'video-mode':'';
  });

  // === CAPTURE ===
  $('shutterBtn').onclick=async()=>{
    if(mode==='photo'){if(timerSec>0)await runTimer();takePhoto()}
    else{if(recording)stopRec();else{if(timerSec>0)await runTimer();startRec()}}
  };

  function runTimer(){
    return new Promise(r=>{let s=timerSec;const d=$('timerDisplay');d.style.display='block';d.textContent=s;
    const iv=setInterval(()=>{s--;if(s<=0){clearInterval(iv);d.style.display='none';r()}else d.textContent=s},1000)});
  }

  // === PHOTO ===
  function takePhoto(){
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    const f=FILTERS[filterIdx];
    ctx.filter=f.css==='none'?'none':f.css;
    if(facing==='user'){ctx.translate(canvas.width,0);ctx.scale(-1,1)}
    ctx.drawImage(video,0,0);ctx.setTransform(1,0,0,1,0,0);ctx.filter='none';

    $('flashOverlay').classList.add('flash');
    setTimeout(()=>$('flashOverlay').classList.remove('flash'),150);
    if(soundOn)playShutter();

    const mime=fmt==='png'?'image/png':fmt==='webp'?'image/webp':'image/jpeg';
    const name='photo_'+ts()+'.'+fmt;
    canvas.toBlob(blob=>{if(blob)showSave(blob,name,'photo')},mime,quality);
  }

  // === VIDEO ===
  function startRec(){
    chunks=[];
    const vs=video.srcObject;
    const audioTracks=vs.getAudioTracks();
    if(audioTracks.length>0){
      beginRec(vs);
    } else {
      // Аудио нет в потоке — запрашиваем ТОЛЬКО аудио (не video+audio)
      navigator.mediaDevices.getUserMedia({
        audio:{
          channelCount:{ideal:2},
          sampleRate:{ideal:48000},
          echoCancellation:{ideal:false},
          noiseSuppression:{ideal:false},
          autoGainControl:{ideal:false}
        }
      }).then(audioStream=>{
        const combined=new MediaStream([...vs.getVideoTracks(),...audioStream.getAudioTracks()]);
        beginRec(combined);
      }).catch(()=>beginRec(vs));
    }
  }

  function beginRec(s){
    const types=['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm','video/mp4;codecs=avc1','video/mp4',''];
    for(const t of types){try{recorder=new MediaRecorder(s,t?{mimeType:t}:undefined);break}catch(e){continue}}
    if(!recorder){toast('Запись не поддерживается');return}
    recorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data)};
    recorder.onstop=async()=>{
      lastRecDurationMs=Date.now()-recStart;
      const mt=recorder.mimeType||'video/webm',ext=mt.includes('mp4')?'mp4':'webm';
      let blob=new Blob(chunks,{type:mt});
      if(ext==='webm'){blob=await fixWebmDuration(blob,lastRecDurationMs)}
      showSave(blob,'video_'+ts()+'.'+ext,'video');
    };
    recorder.start();recording=true;
    $('shutterBtn').classList.add('recording');$('shutterBtn').classList.remove('video-mode');
    $('recordIndicator').style.display='flex';recStart=Date.now();
    recInterval=setInterval(()=>{
      const el=Math.floor((Date.now()-recStart)/1000);
      $('recordTime').textContent=String(Math.floor(el/60)).padStart(2,'0')+':'+String(el%60).padStart(2,'0');
    },1000);
  }

  function stopRec(){
    if(recorder&&recorder.state!=='inactive')recorder.stop();
    recording=false;$('shutterBtn').classList.remove('recording');$('shutterBtn').classList.add('video-mode');
    $('recordIndicator').style.display='none';clearInterval(recInterval);
  }

  // ==============================
  // === FIX WEBM DURATION ===
  // ==============================
  function fixWebmDuration(blob,durationMs){
    return blob.arrayBuffer().then(buf=>{
      const bytes=new Uint8Array(buf);
      const dv=new DataView(buf);

      // EBML VINT reader
      function readVint(off){
        let len=1,val=bytes[off],mask=0x80;
        while(!(val&mask)&&len<8){len++;mask>>=1}
        val&=(mask-1);
        for(let i=1;i<len;i++) val=(val*256)+bytes[off+i];
        return{len,val};
      }
      function readId(off){
        let len=1,val=bytes[off],mask=0x80;
        while(!(val&mask)&&len<4){len++;mask>>=1}
        let id=0;
        for(let i=0;i<len;i++) id=(id*256)+bytes[off+i];
        return{len,id};
      }

      // Контейнеры в которые надо входить
      const containers=new Set([0x18538067,0x1549A966,0x114D9B74]);
      let pos=0;
      while(pos<Math.min(bytes.length-4,4000)){
        const idR=readId(pos);
        if(idR.id===0||idR.len>4||pos+idR.len>=bytes.length) break;
        const szR=readVint(pos+idR.len);
        const dataOff=pos+idR.len+szR.len;

        if(idR.id===0x4489){ // Duration
          if(szR.val===4){dv.setFloat32(dataOff,durationMs)}
          else if(szR.val===8){dv.setFloat64(dataOff,durationMs)}
          return new Blob([buf],{type:blob.type});
        }

        if(containers.has(idR.id)){
          pos=dataOff; // входим внутрь контейнера
        } else {
          pos=dataOff+szR.val; // пропускаем элемент
        }
      }
      return blob; // Duration не найден
    });
  }

  // ==============================
  // === SAVE SCREEN (ГЛАВНОЕ!) ===
  // ==============================
  function showSave(blob,name,type){
    pendingBlob=blob;pendingName=name;pendingType=type;
    const body=$('saveBody');
    body.innerHTML='';

    if(type==='photo'){
      // Показываем фото как <img> — пользователь может зажать → "Сохранить"
      const img=document.createElement('img');
      img.src=URL.createObjectURL(blob);
      img.alt='Фото';
      body.appendChild(img);
      $('saveHint').innerHTML='';
    } else {
      // Показываем видео — используем MediaSource для гарантированной перемотки
      const vid=document.createElement('video');
      vid.controls=true;
      vid.playsInline=true;
      vid.setAttribute('controlsList','noremote');
      vid.style.maxWidth='100%';vid.style.maxHeight='100%';vid.style.objectFit='contain';
      body.appendChild(vid);

      const durationSec=lastRecDurationMs/1000;
      const mimeType=blob.type||'video/webm;codecs=vp8';

      // Пробуем MediaSource API (даёт нормальную перемотку)
      if(window.MediaSource&&MediaSource.isTypeSupported(mimeType)){
        const ms=new MediaSource();
        vid.src=URL.createObjectURL(ms);
        ms.addEventListener('sourceopen',async()=>{
          try{
            const sb=ms.addSourceBuffer(mimeType);
            const arrBuf=await blob.arrayBuffer();
            sb.appendBuffer(arrBuf);
            sb.addEventListener('updateend',()=>{
              try{
                if(ms.readyState==='open'){
                  ms.duration=durationSec;
                  ms.endOfStream();
                }
                vid.play().catch(()=>{});
              }catch(e){}
            },{once:true});
          }catch(e){
            // Fallback на blob URL
            vid.src=URL.createObjectURL(blob);
            vid.play().catch(()=>{});
            applySeekFix(vid);
          }
        },{once:true});
      } else {
        // Fallback для Safari и др.
        vid.src=URL.createObjectURL(blob);
        vid.autoplay=true;
        applySeekFix(vid);
      }

      $('saveHint').innerHTML='Нажмите <b>Скачать</b> или <b>Отправить</b>';
    }

    $('saveScreen').classList.add('show');
  }

  // Fallback фикс перемотки через currentTime трюк
  function applySeekFix(vid){
    vid.addEventListener('loadedmetadata',()=>{
      if(vid.duration===Infinity||isNaN(vid.duration)){
        vid.currentTime=1e101;
        vid.addEventListener('timeupdate',function fix(){
          vid.removeEventListener('timeupdate',fix);
          vid.currentTime=0;
          vid.play().catch(()=>{});
        });
      }
    });
  }

  // Кнопка "Назад"
  $('saveBackBtn').onclick=()=>{
    $('saveScreen').classList.remove('show');
    cleanupSave();
  };

  // Кнопка "Скачать" — пробуем все способы
  $('saveDownBtn').onclick=()=>{
    if(!pendingBlob)return;

    // Способ 1: Создаём <a> с download в новом контексте
    const url=URL.createObjectURL(pendingBlob);
    const a=document.createElement('a');
    a.href=url;
    a.download=pendingName;

    // Для iOS Safari нужно добавить в DOM и кликнуть
    document.body.appendChild(a);

    // Таймаут чтобы iOS успел
    setTimeout(()=>{
      a.click();
      setTimeout(()=>{
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },1000);
    },100);

    // Для iOS: также открываем в новой вкладке как fallback
    // Пользователь сможет зажать и сохранить оттуда
    if(/iPhone|iPad|iPod/i.test(navigator.userAgent)){
      // На iOS a.download часто не работает
      // Открываем blob в новой вкладке
      const w=window.open();
      if(w){
        if(pendingType==='photo'){
          w.document.write('<html><head><title>'+pendingName+'</title><meta name="viewport" content="width=device-width"><style>*{margin:0;padding:0;background:#000}img{width:100%;height:100vh;object-fit:contain}</style></head><body><img src="'+URL.createObjectURL(pendingBlob)+'" alt="photo"></body></html>');
        }else{
          w.document.write('<html><head><title>'+pendingName+'</title><meta name="viewport" content="width=device-width"><style>*{margin:0;padding:0;background:#000}video{width:100%;height:100vh;object-fit:contain}</style></head><body><video src="'+URL.createObjectURL(pendingBlob)+'" controls autoplay playsinline></video></body></html>');
        }
        w.document.close();
      }
    }

    toast('Скачивание...');
  };

  // Кнопка "Отправить" — загрузка на tempshare.su на 1 день
  $('saveShareBtn').onclick=async()=>{
    if(!pendingBlob)return;

    // Создаём оверлей с прогрессом
    const ov=document.createElement('div');
    ov.className='upload-overlay';
    ov.innerHTML=`
      <svg class="upload-progress-ring" viewBox="0 0 80 80">
        <circle class="ring-bg" cx="40" cy="40" r="36"/>
        <circle class="ring-fill" cx="40" cy="40" r="36"/>
      </svg>
      <div class="upload-pct">0%</div>
      <div class="upload-status">Отправка файла...</div>
    `;
    $('saveScreen').appendChild(ov);

    const ringFill=ov.querySelector('.ring-fill');
    const pctEl=ov.querySelector('.upload-pct');
    const statusEl=ov.querySelector('.upload-status');
    const circumference=2*Math.PI*36; // ~226

    function setProgress(p){
      const pct=Math.round(p);
      pctEl.textContent=pct+'%';
      ringFill.style.strokeDashoffset=circumference-(circumference*p/100);
    }

    const fd=new FormData();
    fd.append('file',new File([pendingBlob],pendingName,{type:pendingBlob.type}));
    fd.append('duration','1');

    const xhr=new XMLHttpRequest();
    xhr.open('POST','https://api.tempshare.su/upload');

    xhr.upload.onprogress=(e)=>{
      if(e.lengthComputable){
        setProgress((e.loaded/e.total)*100);
      }
    };

    xhr.onload=async()=>{
      try{
        const data=JSON.parse(xhr.responseText);
        if(data.success&&data.raw_url){
          setProgress(100);
          statusEl.textContent='Готово!';

          // Копируем ссылку
          if(navigator.clipboard&&navigator.clipboard.writeText){
            await navigator.clipboard.writeText(data.raw_url);
          } else {
            const ta=document.createElement('textarea');
            ta.value=data.raw_url;ta.style.position='fixed';ta.style.opacity='0';
            document.body.appendChild(ta);ta.select();document.execCommand('copy');
            document.body.removeChild(ta);
          }

          setTimeout(()=>{
            ov.remove();
            toast('Ссылка на скачивание скопирована');
          },600);
        } else {
          ov.remove();
          toast('Ошибка загрузки');
        }
      }catch(e){
        ov.remove();
        toast('Ошибка ответа сервера');
      }
    };

    xhr.onerror=()=>{
      ov.remove();
      toast('Ошибка сети');
    };

    xhr.send(fd);
  };

  function cleanupSave(){
    const body=$('saveBody');
    const img=body.querySelector('img');
    const vid=body.querySelector('video');
    if(img&&img.src)URL.revokeObjectURL(img.src);
    if(vid&&vid.src){vid.pause();URL.revokeObjectURL(vid.src)}
    body.innerHTML='';
    pendingBlob=null;
  }

  // === SETTINGS ===
  $('settingsBtn').onclick=()=>$('settingsPanel').style.display='flex';
  $('settingsCloseBtn').onclick=()=>$('settingsPanel').style.display='none';

  $('photoResOpts').querySelectorAll('.res-btn').forEach(b=>b.onclick=()=>{
    photoRes=b.dataset.val;$('photoResOpts').querySelectorAll('.res-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  });
  $('videoResOpts').querySelectorAll('.res-btn').forEach(b=>b.onclick=()=>{
    videoRes=b.dataset.val;$('videoResOpts').querySelectorAll('.res-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  });
  $('formatOpts').querySelectorAll('.res-btn').forEach(b=>b.onclick=()=>{
    fmt=b.dataset.val;$('formatOpts').querySelectorAll('.res-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  });
  $('qualityRange').oninput=function(){quality=parseFloat(this.value);$('qualityLabel').textContent=Math.round(quality*100)+'%'};
  $('soundToggle').onclick=()=>{
    soundOn=!soundOn;
    $('soundToggle').querySelector('.toggle-track').classList.toggle('on',soundOn);
    $('soundToggle').querySelector('.toggle-dot').classList.toggle('on',soundOn);
  };

  // === POPUPS ===
  function togglePopup(id){
    const el=$(id),show=el.style.display!=='flex';
    document.querySelectorAll('.popup-panel').forEach(p=>p.style.display='none');
    if(show)el.style.display='flex';
  }
  document.addEventListener('click',e=>{
    if(!e.target.closest('#timerBtn')&&!e.target.closest('#timerOptions'))$('timerOptions').style.display='none';
    if(!e.target.closest('#ratioBtn')&&!e.target.closest('#ratioSelector'))$('ratioSelector').style.display='none';
  });

  // === PINCH ZOOM ===
  let iD=0,iZ=1;
  $('videoContainer').addEventListener('touchstart',e=>{if(e.touches.length===2){iD=gD(e.touches[0],e.touches[1]);iZ=zoom}});
  $('videoContainer').addEventListener('touchmove',e=>{if(e.touches.length===2){e.preventDefault();const d=gD(e.touches[0],e.touches[1]),nz=Math.min(maxZoom,Math.max(1,iZ*(d/iD)));$('zoomRange').value=nz;applyZoom(nz)}},{passive:false});
  function gD(a,b){return Math.sqrt((b.clientX-a.clientX)**2+(b.clientY-a.clientY)**2)}

  // === SOUNDS ===
  function playShutter(){try{const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=1200;g.gain.value=.15;o.start();g.gain.exponentialRampToValueAtTime(.001,c.currentTime+.1);o.stop(c.currentTime+.1)}catch(e){}}

  function toast(m){const el=$('toast');el.textContent=m;el.classList.add('show');clearTimeout(toast._t);toast._t=setTimeout(()=>el.classList.remove('show'),2000)}
  function ts(){const d=new Date();return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'_'+String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0')+String(d.getSeconds()).padStart(2,'0')}

  document.addEventListener('dblclick',e=>e.preventDefault());

  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    $('permScreen').querySelector('p').textContent='Ваш браузер не поддерживает камеру. Используйте Chrome или Safari.';
    $('permBtn').style.display='none';
  }
})();
</script>

</body>
</html>
